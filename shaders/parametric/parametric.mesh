#version 450
#extension GL_EXT_mesh_shader : require
#extension GL_GOOGLE_include_directive : require

#include "../shaderInterface.h"
#include "../common.glsl"
#include "parametricSurfaces.glsl"

// 32 threads for parallel vertex/primitive generation
layout(local_size_x = 32) in;

// Output limits: max tile is 11x11 (144 verts, 242 prims)
// GPU max: 256 verts, 256 prims
layout(max_vertices = 256, max_primitives = 256, triangles) out;

// Must match task shader payload
struct TaskPayload {
    vec3 position;
    vec3 normal;
    float area;
    uint taskId;
    uint isVertex;
    uint elementType;
    uint resolutionM;
    uint resolutionN;
    uint deltaU;
    uint deltaV;
};

taskPayloadSharedEXT TaskPayload payload;

// Per-vertex outputs
layout(location = 0) out PerVertexData {
    vec4 worldPosU;  // xyz = world position, w = u coordinate
    vec4 normalV;    // xyz = world normal, w = v coordinate
} vOut[];

// Per-primitive outputs
layout(location = 2) perprimitiveEXT out PerPrimitiveData {
    flat uvec4 data;  // x = taskId, y = isVertex, z = elementType, w = unused
} pOut[];

layout(push_constant) uniform PushConstants {
    mat4 model;
    uint nbFaces;
    uint nbVertices;
    uint elementType;
    float userScaling;
    float torusMajorR;
    float torusMinorR;
    float sphereRadius;
    uint resolutionM;
    uint resolutionN;
    uint debugMode;
    uint enableCulling;
} push;

layout(set = SET_SCENE, binding = BINDING_VIEW_UBO) uniform ViewUBOBlock {
    mat4 view;
    mat4 projection;
    vec4 cameraPosition;
    float nearPlane;
    float farPlane;
} viewUBO;

void main() {
    // Read resolution and tile info from payload
    uint M = payload.resolutionM;
    uint N = payload.resolutionN;
    uint deltaU = payload.deltaU;
    uint deltaV = payload.deltaV;

    // Compute UV offset for this tile using workgroup ID
    uint tileU = gl_WorkGroupID.x;
    uint tileV = gl_WorkGroupID.y;
    uint startU = tileU * deltaU;
    uint startV = tileV * deltaV;

    // Handle edge tiles (may be smaller than deltaU x deltaV)
    uint localM = min(deltaU, M - startU);
    uint localN = min(deltaV, N - startV);

    uint numVerts = (localM + 1) * (localN + 1);
    uint numQuads = localM * localN;
    uint numPrims = numQuads * 2;

    SetMeshOutputsEXT(numVerts, numPrims);

    mat4 mvp = viewUBO.projection * viewUBO.view * push.model;
    uint localId = gl_LocalInvocationID.x;

    // Generate vertices in parallel
    for (uint i = localId; i < numVerts; i += 32) {
        uint u = i % (localM + 1);
        uint v = i / (localM + 1);

        // Map local tile UV to global UV [0,1]
        vec2 uv = vec2(startU + u, startV + v) / vec2(M, N);

        // Evaluate parametric surface in local space
        vec3 localPos, localNormal;
        evaluateParametricSurface(uv, localPos, localNormal, payload.elementType,
                                   push.torusMajorR, push.torusMinorR, push.sphereRadius);

        // Transform to world space via offsetVertex
        vec3 worldPos, worldNormal;
        offsetVertex(localPos, localNormal,
                     payload.position, payload.normal, payload.area, push.userScaling,
                     worldPos, worldNormal);

        vOut[i].worldPosU = vec4(worldPos, uv.x);
        vOut[i].normalV = vec4(worldNormal, uv.y);
        gl_MeshVerticesEXT[i].gl_Position = mvp * vec4(worldPos, 1.0);
    }

    // Generate triangle indices in parallel
    for (uint q = localId; q < numQuads; q += 32) {
        uint qu = q % localM;
        uint qv = q / localM;

        uint v00 = qv * (localM + 1) + qu;
        uint v10 = v00 + 1;
        uint v01 = v00 + (localM + 1);
        uint v11 = v01 + 1;

        uint triId0 = 2 * q;
        uint triId1 = 2 * q + 1;

        gl_PrimitiveTriangleIndicesEXT[triId0] = uvec3(v00, v10, v11);
        gl_PrimitiveTriangleIndicesEXT[triId1] = uvec3(v00, v11, v01);

        pOut[triId0].data = uvec4(payload.taskId, payload.isVertex, payload.elementType, 0);
        pOut[triId1].data = uvec4(payload.taskId, payload.isVertex, payload.elementType, 0);
    }
}
